# 적정 스레드 개수에 대해 고려해야할 점이 무엇이 있을까요?

사실 이런모델이 많이 필요한곳은 주로 대규모서비스이니까 대규모부터 이야기를 하려는데

예를들어 이런 아키텍처를 생각해봅시당

![image-20211105162612268](https://user-images.githubusercontent.com/58545240/140474893-b7175208-38e1-49b4-80ca-a365aee85133.png)

그림에 있는거처럼 사실 API서버 앞에 로드밸런서 있을수도있고, 내부에는 주키퍼같은게 있을수도있고, DNS서버 붙어서 해야되고 그런건 다 생략하고

유저가 API서버한테 쓰기요청을하면 그 쓰기요청을 작업큐에 넣고 쓰레드풀에 있는 쓰레드가 작업큐에 있는 작업을 가져와서 디비에 쓰기처리를 합니다 (해당 과정에서 전처리가 있을수도 있음)

자 그럼 이제 대규모서비스니까 저 작업이 엄~~~청 많아진다고 생각해보세요 수백만개의 요청이 큐에있습니다.

빠르게 작업들을 처리하고싶어서 쓰레드풀에 쓰레드를 엄청 많이 늘리려고합니다. 그러면 작업이 빠르게 처리가 될까요?

어떻게 될거같은지 한번 예상해보세요 두둥

근데 현실적으로는 io접근속도 제한이 있는데 이건 무한으로 고려하면 안됩니다 저게 문제에요



DB서버에 쓸 수 있는 IO량이 한정되어있습니다. 즉 저 쓰레드풀에서 쓰레드가 너~무 많아지면 DB부하가 너무 많아지고 DB 레이턴시가 늘어나게 되어 결국 처리량이 낮아집니다.



디비서버를 늘리면 어떻게될까요?



샤딩을 한다고생각해봅시다 유저A의 정보가 기존에는 DB서버 3번에 저장되고있었습니다.

DB서버 샤드 개수가 늘어납니다. 유저 A의 정보는 그대로 DB 3번서버에 저장될까요?



range 샤딩이라면 그대로 3번에 저장되겠지만 모듈러 샤딩이라면 아닐겁니다. 인덱스 샤딩이면 그대로일수도있고 아닐수도있겠죠.

뭐 저런식으로 단순히 디비서버를 늘리는걸 생각하면 데이터의 이동, 데이터의 분산 등 여러가지를 고려해야합니다. 그리고 사실 디비서버를 무한정늘릴수도없습니다.

샤딩이 사실 무제한으로할수있는게 아니라서 결국 샤딩 최대개수의 벽에 부딪히게 됩니다. 



아무튼 결론적으로 쓰레드풀의 쓰레드를 무한정 늘리면? -> DB서버의 부하가 너무 늘어난다 -> 처리량이 떨어진다

그렇다고 쓰레드를 너무 적게 하면? -> 작업큐가 너무 적어진다 -> 작업 처리량이 적어진다



그래서 이부분은 write하게되는 데이터의 크기를 고려해야 합니다. 그리고 사용하는 하드웨어의 성능들도 고려해야하구요. 쓰레드의 개수는 몇개가 적당하다가 아닙니다. 적절한 모니터링을 통해 정해야합니다.

여기서 또 주의해야할점이, 이러한 아키텍처에서는 DB에 write가 바로된게 아니기때문에 내가 쓴 데이터가 바로 보여지지 않을수도있습니다.

예를들어서 DB서버1과 DB서버2가 레플리케이션이라고 생각해봅시다. 나는 DB서버에 write를 했어요. 그런데 비동기처리기때문에 바로 쓰기가 되지는 않습니다.

대신 이 아키텍처에서 캐시를 사용해서 나에게는 캐싱 된 데이터를 보여줍니다.



그리고 DB서버에는 작업큐에서 작업이 가져가져서 실제 write가 되어야 반영이되는데, 심지어 그게 레플리케이션에 반영까지 되어야 완벽하게 DB서버에 쓰기가 끝납니다

예를들어 페이스북의 좋아요를 생각해봅시다 나는 좋아요를 눌렀어요. 그래서 게시글에 좋아요가 보입니다. (캐싱되어있는게 보임)

근데 친구폰에서는 아직 DB서버에 반영이 안되어서 내가 누른 좋아요가 안보입니다. 그러다가 레플리 반영까지 다 되고나면 친구한테도 내가 누른 좋아요가 보이게되는거죠. 이런식으로 단계별 작업들이 일어납니다.

 

소규모 프로그램도 마찬가지로, 예를 들어
인풋 쓰레드 -> 작업쓰레드(쓰레드풀) -> 아웃풋쓰레드
의 아키텍처를 설계했다고 합시다.

입력받은 데이터를 어떻게 프로세싱해서 다시 아웃풋해야되는 프로그램인데
여기서 쓰레드풀의 쓰레드가 늘어날수록 단일 머신의 CPU 부하가 늘어나게됩니다. 반대로 너무 적어지면 프로세싱이 늦춰지죠. 이런것도 고려하면됩니다.



# 그럼 혹시 대규모 트래픽의 알림 서비스를 구축한다하면 어떤식으로 하시겠어용??

서버단에서의 장애같은 알림서비스말하는건가요 클라이언트에게 보내는 알림서비스말하는건가요

클라이언트에게 보내는 알림서비스요 예를 들면 좋아요 알림, 구독알림 이런거요!!

![image-20211105184449126](C:\Users\USER\AppData\Roaming\Typora\typora-user-images\image-20211105184449126.png)

1. 그림과 같이 API서버에서 여러 서비스를 호출하도록 설계
2. 여러 서비스 중 notification 서비스를 만들어둠
3. 클라이언트가 게시글이던 댓글이던 좋아요던 API서버에 write 요청을 보냄
3-2. 코멘트(댓글) write라고 가정하고, 정말 간단하게 생각하면 단순히 코멘트를 다는 게시글의 작성자에게 notification 전달하면 끝나는 일. 하지만 대규모 서비스는 고려해야할 것들이 많음
4. write 작업을 DB에 아까 말한거처럼 비동기로 전달하고, notification 서비스 호출
5. notification을 누구에게 보낼것인가 정해야 함
5-2. 예를들어 친구들이라던지 해당 글에 글쓴이와 댓글 단 사람 목록이라던지.. 퉁쳐서 팔로워라고 가정
5-3. 이 팔로워만 잘 구해낸다면 noti 보내는거야 그냥 보내면 됨.
6. 어찌저찌 팔로워 리스트 캐싱이 잘 되어서 잘 가져왔다고 가정. noti 보낼 때 그 게시글 혹은 댓글에 대한 정보가 포함되어야 함.
7. 그 게시글/댓글은 어떻게 구분할것인가? 게시글 번호? 댓글 번호?
8. GUID라는걸 이용해야함. 트위터의 SnowFlake와 같이 Timestamp, 데이터센터ID, 워커ID, 시퀀스 등을 조합하여 게시글/댓글에 대한 ID를 부여하여 그 ID만으로 어떤 데이터센터에 저장되어있는 몇번째 시간순서의 글인지 알 수 있게 함
9. 즉 noti는 저 GUID 정보를 포함해서 팔로워들에게 알람을 보냄

참고로 noti보다 그 페북같은데서 저희가 보고있는 페이지에 있는 글의 새로운 댓글추가/좋아요 변경이 훨~씬 복잡합니다

https://www.facebook.com/notes/10158791486967200/





# 통신 네트워크 관련

Http 자체에서 메세지 크기가 커질때도 순서 잘맞고 잘 온 메세지인지 신뢰도 체크할수가 있나요?
저는 tcp가 신뢰도 체킹하고 올려주니까 괜찮을거같다고 했는데 먼가 잘못 말한거같아서..



udp로 신뢰성 보장하는건 udp 위에 올리는 페이로드에 커스텀 헤더를 만들거나 해서 그걸로 프로토콜 잘 설계하면 됩니닼

가희님 말한 tcp 헤더 쓰는게 크게 틀린건 아니에요 왜 tcp 안쓰고 udp로 저렇게 하냐

tcp보다 효율적으로 프로토콩 설계할 자신이있으니까요



???: 근데 tcp 헤더를 udp에 추가하는 건 딱히 틀린 게 아니라는 건 놀랍네요 ㅋㅋ

tcp헤더를 전부 추가하는건 아니고 tcp헤더같은 내용들 중 지들이필요한내용을 올리고 필요없는거 컷하고 더 필요한건 올리고

그리고 생각해보시면 ttp에 content length필드있죠? tcp가 스트림이라서 데이터 경계가없잖아요? 그러니까 윗단에서 하나의 데이터가 바운더리가 어디까지인지 저런식으로 헤더로 처리를 해야하는데 udp는 바운더리가 있는 청크데이터라서 저런것도 사실 핗요없어집니당ㅋ



sctp라고 tcp처럼 연결지향하는데 저런 이미지나 동영상같은 멀티미디어 데이터 스트림용으로 멀티채널 구성하는 프로토콜이 나왔었는데 quic가 저런기능도 다 뺏어갔습니다ㅋ

quic에는 ssl의 인증이나 암호화 기능도 탑재했고 진짜 sctp dccp tls 등여기저기서 좋아보이는거 다가져와서 이거보다 좋은거 못만듦ㅋ 하고 발표한게 quic



RTP RTCP RTMP 이런것들 다 모아서 공부해보시는게 편하실거에용



# jwt, 토큰, 쿠키 관련

1. 로그인후 토큰은 클라이언트가 받아 헤더에 저장해둠

2. 클라이언트는 api 요청시마다 헤더에 토큰을 같이 실어보냄

3. 서버에서는 인터셉터에서 먼저 유효한 토큰인지 검증 

4. 검증 되었다면 api 진행~~